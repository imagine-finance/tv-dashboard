# CLAUDE.md

Instructions for Claude Code working in this repository.

## What This Repo Does

This is a self-contained automated TV dashboard pipeline for the Gen H office displays. It fetches live business metrics from BigQuery (via Lightdash), renders an animated video using Remotion, and deploys it to GitHub Pages where Zoom Rooms digital signage picks it up.

**Live URL**: https://imagine-finance.github.io/tv-dashboard/

## Architecture

```
GitHub Actions (daily cron @ 7am UTC, Mon-Fri)
  -> Lightdash CLI fetches metrics from BigQuery (production_rdo_replica)
  -> Python script writes metrics.json
  -> Remotion renders 1920x1080 MP4 (4 scenes, 28 seconds, looping)
  -> Force-push MP4 + index.html to gh-pages branch
  -> GitHub Pages serves the video

Zoom Rooms digital signage -> loads the GitHub Pages URL -> auto-refreshes every 4 hours
```

## Repository Structure

```
tv-dashboard/
  .github/workflows/generate-dashboard.yml  # CI pipeline (cron + manual trigger)
  generate.sh                                # Self-contained build script
  index.html                                 # Video player page (deployed to gh-pages)
  scripts/
    fetch-dashboard-metrics.py               # Fetches metrics via Lightdash CLI
  remotion-dashboard/
    package.json                             # Remotion 4.0.261 + React 18
    remotion.config.ts                       # Render config (JPEG, overwrite)
    data/metrics.json                        # Dashboard data (generated by fetch script)
    public/
      fonts/                                 # TuskerGrotesk-8700Bold, IBMPlexSans-Medium
      genh.svg                               # Gen H logo
      assets/                                # Scene imagery
    src/
      index.ts                               # Remotion entry point
      Root.tsx                               # Composition: 1920x1080, 30fps, 840 frames
      Dashboard.tsx                          # Main orchestrator (scene timing, transitions)
      fonts.ts                               # Font family constants
      types.ts                               # TypeScript interfaces
      components/                            # Reusable animated components
        MetricCard.tsx                        # Big number + label cards
        FunderRing.tsx                        # Circular progress rings
        SceneTitle.tsx                        # Title + subtitle with entrance animation
        TrendChart.tsx                        # Vertical bar chart
        HorizontalBar.tsx                    # Horizontal progress bars
        StatRow.tsx                           # Row of stat boxes
      scenes/                                # 4 dashboard scenes (7 sec each)
        OverviewScene.tsx                    # 6 metric cards + 5 funder rings
        LendingScene.tsx                     # Completions chart + lending stats
        ActiveBookScene.tsx                  # Book size + portfolio stats
        FunderScene.tsx                      # Funder utilisation bars
```

## Development Commands

### Local rendering (requires Lightdash CLI auth + Node.js 18+)
```bash
# Full pipeline (fetch data + render)
./generate.sh

# Just render with existing metrics.json
cd remotion-dashboard && npm install && npm run render

# Interactive preview in browser
cd remotion-dashboard && npm run dev
```

### Manual workflow trigger
```bash
gh workflow run generate-dashboard.yml --repo imagine-finance/tv-dashboard
gh run watch --repo imagine-finance/tv-dashboard
```

### Check workflow history
```bash
gh run list --repo imagine-finance/tv-dashboard --limit 5
```

## GitHub Secrets

These are configured in the repo settings and used by the CI workflow:

| Secret | Purpose |
|--------|---------|
| `LIGHTDASH_API_KEY` | API token for Lightdash CLI authentication |
| `LIGHTDASH_SERVER_URL` | Lightdash instance URL (https://app.lightdash.cloud) |
| `LIGHTDASH_PROJECT_ID` | Lightdash project UUID for production_rdo_replica |

## Key Design Decisions

- **Force-push to gh-pages**: Keeps the repo small by not accumulating video history
- **GitHub Pages hosting**: Free, reliable, no auth needed for Zoom Rooms
- **4-hour auto-refresh**: `<meta http-equiv="refresh">` in index.html ensures TVs pick up new videos
- **Remotion**: Programmatic video generation with React components, deterministic output
- **Lightdash CLI**: Runs SQL against production_rdo_replica (Postgres) without direct DB access

## Fonts

Both fonts must be committed to the repo (CI doesn't have them installed):
- `TuskerGrotesk-8700Bold.ttf` - Titles, big numbers, headings
- `IBMPlexSans-Medium.ttf` - Body text, labels, subtitles

## Modifying the Dashboard

- **Add/change metrics**: Edit `scripts/fetch-dashboard-metrics.py` SQL queries and `remotion-dashboard/src/types.ts`
- **Change layout/sizing**: Edit files in `remotion-dashboard/src/components/` and `remotion-dashboard/src/scenes/`
- **Change scene timing**: Edit `SCENE_DURATION` and `TRANSITION` constants in `Dashboard.tsx`
- **Change schedule**: Edit the cron expression in `.github/workflows/generate-dashboard.yml`
- **Preview locally**: Run `cd remotion-dashboard && npm run dev` to open the Remotion Studio

## Troubleshooting

- **Workflow fails at Lightdash step**: Check secrets are set correctly in repo settings
- **Workflow fails at render step**: Usually missing Chrome dependencies - check the apt-get install step
- **Video not updating on TV**: GitHub Pages CDN cache is up to 10 minutes; also check the 4-hour meta refresh
- **Local render fails**: Ensure `npm install` completed and Chrome is available (`npx remotion browser ensure`)
